<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <title>Passwd by i2bskn</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>Passwd</h1>
        <h2>Password utilities.</h2>

        <section id="downloads">
          <a href="https://github.com/i2bskn/passwd/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/i2bskn/passwd/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/i2bskn/passwd" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<div class="highlight highlight-ruby"><pre><span class="n">gem</span> <span class="s1">'passwd'</span>
</pre></div>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install passwd
</code></pre>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'passwd'</span>
</pre></div>

<h3>
<a name="create-random-password" class="anchor" href="#create-random-password"><span class="octicon octicon-link"></span></a>Create random password</h3>

<div class="highlight highlight-ruby"><pre><span class="n">password</span> <span class="o">=</span> <span class="no">Passwd</span><span class="o">.</span><span class="n">create</span>
</pre></div>

<h3>
<a name="hashing-password" class="anchor" href="#hashing-password"><span class="octicon octicon-link"></span></a>Hashing password</h3>

<p>Hashing with SHA1.</p>

<div class="highlight highlight-ruby"><pre><span class="n">password_hash</span> <span class="o">=</span> <span class="no">Passwd</span><span class="o">.</span><span class="n">hashing</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</pre></div>

<h3>
<a name="password-settings" class="anchor" href="#password-settings"><span class="octicon octicon-link"></span></a>Password settings</h3>

<p>Default config is stored in the class instance variable.
Changing the default configs are as follows:</p>

<div class="highlight highlight-ruby"><pre><span class="no">Passwd</span><span class="o">.</span><span class="n">config</span> <span class="c1"># =&gt; Get config object.</span>
<span class="no">Passwd</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="ss">length</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># =&gt; Change to the default length.</span>

<span class="no">Passwd</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">end</span>
</pre></div>

<p>Options that can be specified:</p>

<ul>
<li>:length =&gt; Number of characters. default is 8.</li>
<li>:lower =&gt; Skip lower case if set false. default is true.</li>
<li>:upper =&gt; Skip upper case if set false. default is true.</li>
<li>:number =&gt; Skip numbers if set false. default is true.</li>
<li>:letters_lower =&gt; Define an array of lower case. default is ("a".."z").to_a</li>
<li>:letters_upper =&gt; Define an array of upper case. default is ("A".."Z").to_a</li>
<li>:letters_number =&gt; Define an array of numbers. default is ("0".."9").to_a</li>
</ul><h3>
<a name="policy-check" class="anchor" href="#policy-check"><span class="octicon octicon-link"></span></a>Policy check</h3>

<p>Default policy is 8 more characters and require lower case and require number.</p>

<div class="highlight highlight-ruby"><pre><span class="no">Passwd</span><span class="o">.</span><span class="n">policy_check</span><span class="p">(</span><span class="s2">"secret"</span><span class="p">)</span> <span class="c1"># =&gt; true or false</span>
</pre></div>

<h3>
<a name="policy-settings" class="anchor" href="#policy-settings"><span class="octicon octicon-link"></span></a>Policy settings</h3>

<div class="highlight highlight-ruby"><pre><span class="no">Passwd</span><span class="o">.</span><span class="n">policy_configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="o">.</span><span class="n">min_length</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">end</span>
</pre></div>

<p>Options that can be specified:</p>

<ul>
<li>:min_length =&gt; Number of minimum characters. default is 8.</li>
<li>:require_lower =&gt; Require lower case if set true. default is true.</li>
<li>:require_upper =&gt; Require upper case if set true. default is false.</li>
<li>:require_number =&gt; Require number if set true. default is true.</li>
</ul><h3>
<a name="password-object" class="anchor" href="#password-object"><span class="octicon octicon-link"></span></a>Password object</h3>

<p>Default password is randomly generated.
Default salt is "#{Time.now.to_s}".</p>

<div class="highlight highlight-ruby"><pre><span class="n">password</span> <span class="o">=</span> <span class="ss">Passwd</span><span class="p">:</span><span class="ss">:Password</span><span class="o">.</span><span class="n">new</span>
<span class="n">password</span><span class="o">.</span><span class="n">text</span> <span class="c1"># return text password.</span>
<span class="n">password</span><span class="o">.</span><span class="n">salt_text</span> <span class="c1"># return text salt.</span>
<span class="n">password</span><span class="o">.</span><span class="n">salt_hash</span> <span class="c1"># return hash salt.</span>
<span class="n">password</span><span class="o">.</span><span class="n">hash</span> <span class="c1"># return hash password.</span>
</pre></div>

<p>Options that can be specified:</p>

<ul>
<li>:password =&gt; Text password. default is random.</li>
<li>:salt_text =&gt; Text salt. default is #{Time.now.to_s}.</li>
</ul><p>Password authenticate:</p>

<div class="highlight highlight-ruby"><pre><span class="n">password</span> <span class="o">=</span> <span class="ss">Passwd</span><span class="p">:</span><span class="ss">:Password</span><span class="o">.</span><span class="n">new</span>
<span class="no">Passwd</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">password</span><span class="o">.</span><span class="n">salt_hash</span><span class="p">,</span> <span class="n">password</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
<span class="no">Passwd</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">"invalid!!"</span><span class="p">,</span> <span class="n">password</span><span class="o">.</span><span class="n">salt_hash</span><span class="p">,</span> <span class="n">password</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span> <span class="c1"># =&gt; false</span>

<span class="n">password</span> <span class="o">==</span> <span class="n">password</span><span class="o">.</span><span class="n">text</span> <span class="c1"># =&gt; true</span>
<span class="n">password</span> <span class="o">==</span> <span class="s2">"invalid!!"</span> <span class="c1"># =&gt; false</span>
</pre></div>

<h2>
<a name="for-activerecord" class="anchor" href="#for-activerecord"><span class="octicon octicon-link"></span></a>For ActiveRecord</h2>

<h3>
<a name="user-model" class="anchor" href="#user-model"><span class="octicon octicon-link"></span></a>User model</h3>

<p>Include <code>Passwd::ActiveRecord</code> module and define id/salt/password column from <code>define_column</code> method.<br><code>id</code> column is required uniqueness.</p>

<div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="kp">include</span> <span class="ss">Passwd</span><span class="p">:</span><span class="ss">:ActiveRecord</span>
  <span class="c1"># if not specified arguments for define_column =&gt; {id: :email, salt: :salt, password: :password}</span>
  <span class="n">define_column</span> <span class="nb">id</span><span class="p">:</span> <span class="ss">:id_colname</span><span class="p">,</span> <span class="ss">salt</span><span class="p">:</span> <span class="ss">:salt_colname</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="ss">:password_colname</span>

  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</pre></div>

<p>Available following method by defining id/salt/password column.</p>

<h3>
<a name="authentication" class="anchor" href="#authentication"><span class="octicon octicon-link"></span></a>Authentication</h3>

<p><code>authenticate</code> method is available in both instance and class.<br>
Return the user object if the authentication successful.<br>
Return the nil if authentication fails or doesn't exists user.</p>

<div class="highlight highlight-ruby"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span> <span class="c1"># =&gt; return user object or nil.</span>

<span class="k">if</span> <span class="n">user</span>
  <span class="n">session</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
  <span class="n">redirect_to</span> <span class="n">bar_path</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Hello </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">else</span>
  <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Authentication failed"</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:new</span>
<span class="k">end</span>
</pre></div>

<p>instance method is not required <code>id</code>.</p>

<div class="highlight highlight-ruby"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>

<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span> <span class="c1"># =&gt; return true or false</span>
  <span class="c1"># some process</span>
  <span class="n">redirect_to</span> <span class="n">bar_path</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Some process is successfully"</span>
<span class="k">else</span>
  <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Authentication failed"</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:edit</span>
<span class="k">end</span>
</pre></div>

<h3>
<a name="change-passowrd" class="anchor" href="#change-passowrd"><span class="octicon octicon-link"></span></a>Change passowrd</h3>

<p><code>set_password</code> method will be set random password.<br>
Return value is plain text password.<br>
To specify the password as an argument if you want to specify a password.<br><code>salt</code> also set if salt is nil.</p>

<div class="highlight highlight-ruby"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
<span class="n">password_text</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">set_password</span>

<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">save</span>
  <span class="n">redirect_to</span> <span class="n">bar_path</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Password update successfully"</span>
<span class="k">else</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:edit</span>
<span class="k">end</span>
</pre></div>

<p><code>update_password</code> method will be set new password if the authentication successful.<br>
But <code>update_password</code> method doesn't call <code>save</code> method.</p>

<div class="highlight highlight-ruby"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>

<span class="k">begin</span>
  <span class="no">Passwd</span><span class="o">.</span><span class="n">confirm_check</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:password_confirmation</span><span class="o">]</span><span class="p">)</span>
  <span class="c1"># update_password(OLD_PASSWORD, NEW_PASSWORD[, POLICY_CHECK=false])</span>
  <span class="n">current_user</span><span class="o">.</span><span class="n">update_password</span><span class="p">(</span><span class="n">old_pass</span><span class="p">,</span> <span class="n">new_pass</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">current_user</span><span class="o">.</span><span class="n">save!</span>
  <span class="n">redirect_to</span> <span class="n">bar_path</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">"Password updated successfully"</span>
<span class="k">rescue</span> <span class="ss">Passwd</span><span class="p">:</span><span class="ss">:PasswordNotMatch</span>
  <span class="c1"># PASSWORD != PASSWORD_CONFIRMATION from Passwd.#confirm_check</span>
  <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password not match"</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:edit</span>
<span class="k">rescue</span> <span class="ss">Passwd</span><span class="p">:</span><span class="ss">:AuthError</span>
  <span class="c1"># Authentication failed from #update_password</span>
  <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password is incorrect"</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:edit</span>
<span class="k">rescue</span> <span class="ss">Passwd</span><span class="p">:</span><span class="ss">:PolicyNotMatch</span>
  <span class="c1"># Policy not match from #update_password</span>
  <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Policy not match"</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:edit</span>
<span class="k">rescue</span>
  <span class="c1"># Other errors</span>
  <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:alert</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Password update failed"</span>
  <span class="n">render</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:edit</span>
<span class="k">end</span>
</pre></div>
      </section>
    </div>

    
  </body>
</html>